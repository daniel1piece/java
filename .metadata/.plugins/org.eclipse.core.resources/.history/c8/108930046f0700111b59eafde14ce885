package platzi.play.utils;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import platzi.play.contenido.Genero;
import platzi.play.contenido.Pelicula;
import platzi.play.contenido.Contenido;
import platzi.play.contenido.Documental;

public class FileUtils {
	
	public static final String NOMBRE_ARCHIVO = "contenido.txt";
	public static final String SEPARADOR = "|";
	
	public static void escribirContenido(Contenido contenido) {
//		String linea = contenido.getTitulo() + SEPARADOR + contenido.getDuracion() + SEPARADOR + contenido.getGenero() + SEPARADOR + contenido.getCalificacion() + SEPARADOR + contenido.getFechaEstreno(); 
		String linea = String.join(SEPARADOR, 
				contenido.getTitulo(), 
				String.valueOf(contenido.getDuracion()), 
				contenido.getGenero().name(), 
				String.valueOf(contenido.getCalificacion()), 
				contenido.getFechaEstreno().toString()
				);
		
		String lineaFinal;
		
		if (contenido instanceof Documental documental) {
//			Documental documental = (Documental) contenido;
			lineaFinal = "DOCUMENTAL" + SEPARADOR + linea + SEPARADOR + documental.getNarrador();
		} else {
			lineaFinal = "PELICULA" + SEPARADOR + linea;
		}
		
		try {
			Files.writeString(Paths.get("contenido.txt"), 
					lineaFinal + 
					System.lineSeparator(),
					StandardOpenOption.CREATE,
					StandardOpenOption.APPEND);
		} catch (IOException e) {
			System.out.println("Error escribiendo el archivo. " + e.getMessage());
		}

	}
	
	public static List<Contenido> leerContenido() {
		List<Contenido> contenidoDesdeArchivo = new ArrayList<>();
		
		try {
			List<String> lineas = Files.readAllLines(Paths.get(NOMBRE_ARCHIVO));
			
			lineas.forEach(linea -> {
				String[] datos = linea.split("\\" + SEPARADOR);
				
				String tipoContenido = datos[0];
				
				if ("PELICULA".equals(tipoContenido) && datos.length == 6 || ("Documental".equals(tipoContenido) && datos.length == 7)) {
					String titulo = datos[1];
					int duracion = Integer.parseInt(datos[2]);
					Genero genero = Genero.valueOf(datos[3]);
					double calificacion = !datos[4].isBlank()? Double.parseDouble(datos[4]):0;
					LocalDate fechaEstreno = datos[5].isBlank() ? LocalDate.of(2000, 1, 1) : LocalDate.parse(datos[4]);
					
					Contenido contenido;
					
					if ("PELICULA".equals(tipoContenido)) {
						contenido = new Pelicula(titulo, duracion, genero, calificacion);
					} else {
						String narrador = datos[6];
						contenido =	new Documental(titulo, duracion, genero, calificacion, narrador);
					}
					
					contenido.setFechaEstreno(fechaEstreno);
					
					contenidoDesdeArchivo.add(contenido);
				}
			});
		} catch (IOException e) {
			System.out.println("Ocurrio un error leyendo el archivo: " + e.getMessage());
		}
		
		return contenidoDesdeArchivo;
	}
}
