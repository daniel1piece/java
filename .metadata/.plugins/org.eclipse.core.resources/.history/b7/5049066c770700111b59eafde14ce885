package platzi.play.plataforma;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import platzi.play.contenido.Genero;
import platzi.play.contenido.Pelicula;
import platzi.play.contenido.Promocionable;
import platzi.play.contenido.Contenido;
import platzi.play.contenido.Documental;
import platzi.play.contenido.ResumenContenido;
import platzi.play.excepcion.PeliculaExistenteExcepcion;
import platzi.play.utils.FileUtils;

public class Plataforma {
	private String nombre;
	private List<Contenido> contenido;
	private Map<Contenido, Integer> vizualicaciones;
	
	public Plataforma(String nombre) {
		this.nombre = nombre;
		this.contenido = new ArrayList<>();
		this.vizualicaciones = new HashMap<>();
	}
	
	public void agregar(Contenido elemento) {
		Contenido contenido = this.buscarPorTitulo(elemento.getTitulo());
		
		if (contenido != null) {
			throw new PeliculaExistenteExcepcion(contenido.getTitulo());
		}
		
		FileUtils.escribirContenido(elemento);
		
		this.contenido.add(elemento);
	}
	
	public void reproducir(Contenido contenido) {
		int conteoActual = vizualicaciones.getOrDefault(contenido, 0);
		System.out.println(contenido.getTitulo() + " ha sido repoducido " + conteoActual + " vececes");
		
		this.contarVizualizacion(contenido);
		contenido.reproducir();
	}
	
	private void contarVizualizacion(Contenido contenido) {
		int conteoActual = vizualicaciones.getOrDefault(contenido, 0);
		vizualicaciones.put(contenido, conteoActual + 1);
	}
	
	public List<String>  getTitulos() {
		return contenido.stream()
		.map(contenido -> contenido.getTitulo())
		.toList();
	}
	
	public List<ResumenContenido> getResumenes() {
		return contenido.stream()
			   .map(contenido -> new ResumenContenido(
			    contenido.getTitulo(), contenido.getDuracion(), contenido.getGenero()))
			   .toList();
	}
	
	public void eliminar(Contenido elemento) {
		this.contenido.remove(elemento);
	}
	
	public Contenido buscarPorTitulo(String titulo) {
		return this.contenido.
		stream().filter(elemento -> 
		elemento.getTitulo().equalsIgnoreCase(titulo))
		.findFirst()
		.orElse(null);	
		 
	}
	
	public List<Contenido> buscarPorGenero(Genero genero) {
		return contenido.stream()
			   .filter(elemento -> elemento.getGenero().equals(genero))
			   .toList();
	}
	
	public List<Contenido> getPopulares(int cantidad) {
		return contenido.stream()
				.sorted(Comparator.comparingDouble(
				 Contenido::getCalificacion
				).reversed())
				.limit(cantidad)
			   .toList();
	}
	
	public List<Pelicula> getPeliculas(){
		return contenido.stream()
				.filter(contenido -> contenido instanceof Pelicula)
				.map(contenidoFiltrado -> (Pelicula) contenidoFiltrado)
				.toList();
	}
	
	public List<Documental> getDocumentales(){
		return contenido.stream()
				.filter(contenido -> contenido instanceof Documental)
				.map(contenidoFiltrado -> (Documental) contenidoFiltrado)
				.toList();
	}
	
	public List<Promocionable> getContenidoPromocionable() {
		return contenido.stream()
				.filter(contenido -> contenido instanceof Promocionable)
	}
	
	public int getDuracionTotal() {
		return contenido.stream()
			   .mapToInt(Contenido::getDuracion)
			   .sum();
	}

	public String getNombre() {
		return nombre;
	}

	public List<Contenido> getContenido() {
		return contenido;
	}
}


















